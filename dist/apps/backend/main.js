(()=>{"use strict";var e={n:t=>{var a=t&&t.__esModule?()=>t.default:()=>t;return e.d(a,{a}),a},d:(t,a)=>{for(var i in a)e.o(a,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:a[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t);const a=require("@anatine/zod-nestjs"),i=require("@nestjs/core"),r=require("@sentry/node"),o=require("express"),s=require("helmet");var n=e.n(s);const c=require("nest-openapi-tools"),d=require("tslib"),p=require("@nestjs/cache-manager"),l=require("@nestjs/common"),u=require("@nestjs/throttler");let m=class AppController{};m=(0,d.__decorate)([(0,l.Controller)()],m);let g=class AppService{};g=(0,d.__decorate)([(0,l.Injectable)()],g);const y=require("@prisma/client");var _;let h,f=_=class PrismaService extends y.PrismaClient{constructor(){return super(),_.instance||(_.instance=this),_.instance}async onModuleInit(){await this.$connect()}};f=_=(0,d.__decorate)([(0,l.Injectable)(),(0,d.__metadata)("design:paramtypes",[])],f),"production"===process.env.NODE_ENV?h=new f:(global.prisma||(global.prisma=new f),h=global.prisma);var v;let b=class ActivityService{constructor(e){this.prisma=e}create(e){return this.prisma.activity.create({data:{type:e.type,importance:e.importance,...e.userId&&{user:{connect:{id:e.userId}}},...e.genreSlug&&{genre:{connect:{slug:e.genreSlug}}},...e.bookSlug&&{book:{connect:{slug:e.bookSlug}}}}})}};b=(0,d.__decorate)([(0,l.Injectable)(),(0,d.__metadata)("design:paramtypes",["function"==typeof(v=void 0!==f&&f)?v:Object])],b);const S=require("@nestjs/config"),w=require("@nestjs/jwt"),k="Invalid google token",A="Email or password invalid",z="User already exist",B="Invalid value provided",O="Something went wrong, please try again later",E="Unknown error, please try again later",j="Not enough rights",P="Invalid chapter",T="Invalid file",x="Invalid folder",R="Book not found",D="Book already exist",C="User not found";const I=e=>("0"+new Date(e).getHours()).slice(-2)+":"+("0"+new Date(e).getMinutes()).slice(-2),U=e=>{const t=e.reduce(((e,t)=>{const a=function(e=new Date){return[e.toLocaleString("default",{year:"numeric"}),e.toLocaleString("default",{month:"2-digit"}),e.toLocaleString("default",{day:"2-digit"})].join("-")}(t.createdAt);return e[a]=e[a]||{date:a,count:0,activities:[]},e[a]?.activities.push({importance:t.importance,message:t.type+` (${t.bookId?`book: ${t.bookId}; `:""}${t.genreId?`genre: ${t.genreId}; `:""}${t.userId?`user: ${t.userId}`:""})`,time:I(t.createdAt)}),e[a].count++,e}),{});return Object.values(t).map((({activities:e,...t})=>({level:e.reduce(((e,{importance:t})=>Math.max(e,t)),0),activities:e,...t})))||[]},N={slug:!0,title:!0,picture:!0,author:!0},M={name:!0,slug:!0,icon:!0},F={select:{slug:!0}},G=(e,t)=>new l.HttpException({status:e,message:t},e),q={id:!0,email:!0};var H,Z;let L=class UserService{constructor(e,t){this.prisma=e,this.activityService=t}async getUserById(e,t={}){const a=await this.prisma.user.findUnique({where:{id:e},select:{...q,...t}});if(!a)throw G(l.HttpStatus.BAD_REQUEST,O);return a}async library(e){const t=await this.prisma.user.findUnique({where:{id:e},select:{readingBooks:{select:N},finishedBooks:{select:N},savedBooks:{select:N}}});if(!t)throw G(l.HttpStatus.BAD_REQUEST,O);const{readingBooks:a,finishedBooks:i,savedBooks:r}=t;return{readingBooks:a,finishedBooks:i,savedBooks:r}}async catalog(e,t){return{data:(await this.prisma.user.findMany({take:20,select:{...q,picture:!0,socialId:!0,role:!0,createdAt:!0,fullName:!0,location:!0,selectedGenres:{select:M},activity:{select:{type:!0,id:!0,importance:!0,createdAt:!0,userId:!0,bookId:!0,genreId:!0}},_count:{select:{savedBooks:!0,review:!0,finishedBooks:!0,readingBooks:!0}}},...t&&{skip:20*t},...e&&{where:{fullName:{contains:e}},...!Number.isNaN(+e)&&{where:{id:+e}}}})).map((({activity:e,...t})=>({...t,activities:U(e)}))),canLoadMore:t<Math.floor(await this.prisma.user.count()/20),totalPages:Math.floor(await this.prisma.user.count()/20)}}async remove(e){const t=await this.getUserById(e);await this.prisma.user.delete({where:{id:t.id}})}async startReading(e,t){await this.checkBookExist(t);const a=await this.getUserById(+e,{readingBooks:F,finishedBooks:F});a.readingBooks.some((e=>e.slug===t))||(await this.activityService.create({type:y.Activities.startedReading,importance:2,userId:e,bookSlug:t}),await this.prisma.user.update({where:{id:a.id},data:{readingBooks:{connect:{slug:t}},savedBooks:{disconnect:{slug:t}},finishedBooks:{disconnect:{slug:t}}}}))}async finishReading(e,t){await this.checkBookExist(t);const a=await this.getUserById(+e,{readingBooks:F});a.readingBooks.some((e=>e.slug===t))&&(await this.activityService.create({type:y.Activities.finishedReading,importance:3,userId:e}),await this.prisma.user.update({where:{id:a.id},data:{readingBooks:{disconnect:{slug:t}},savedBooks:{disconnect:{slug:t}},finishedBooks:{connect:{slug:t}}}}))}async isSaved(e,t){await this.checkBookExist(t);const a=await this.prisma.user.findUnique({where:{id:e},select:{id:!0,savedBooks:F}});if(!a)throw G(l.HttpStatus.BAD_REQUEST,O);return a.savedBooks.some((e=>e.slug===t))}async toggleSave(e,t){await this.checkBookExist(t);const a=await this.prisma.user.findUnique({where:{id:e},select:{id:!0,savedBooks:F}});if(!a)throw G(l.HttpStatus.BAD_REQUEST,O);const i=a.savedBooks.some((e=>e.slug===t));return await this.activityService.create({type:i?y.Activities.removeFromSaved:y.Activities.savedBook,importance:1,userId:e,bookSlug:t}),await this.prisma.user.update({where:{id:a.id},data:{savedBooks:{[i?"disconnect":"connect"]:{slug:t}},...!i&&{readingBooks:{disconnect:{slug:t}},finishedBooks:{disconnect:{slug:t}}}}}),!i}async checkBookExist(e){const t=await this.prisma.book.findUnique({where:{slug:e,isPublic:!0},select:{id:!0,title:!0}});if(!t)throw G(l.HttpStatus.BAD_REQUEST,O);return!!t}};L=(0,d.__decorate)([(0,l.Injectable)(),(0,d.__metadata)("design:paramtypes",["function"==typeof(H=void 0!==f&&f)?H:Object,"function"==typeof(Z=void 0!==b&&b)?Z:Object])],L);const Q=require("@nestjs/swagger"),W=require("@anatine/zod-openapi"),$=require("zod");(0,W.extendZodWithOpenApi)($.z);const V=$.z.object({email:$.z.string().email(),password:$.z.string().min(8)});(0,W.extendZodWithOpenApi)($.z);const X=$.z.object({socialId:$.z.string()}),J=$.z.object({email:$.z.string().email(),role:$.z.nativeEnum(y.Role)}),K=$.z.object({refreshToken:$.z.string()});class GoogleAuthDto extends((0,a.createZodDto)(X)){}class RefreshDto extends((0,a.createZodDto)(K)){}class AuthDto extends((0,a.createZodDto)(V)){}(0,W.extendZodWithOpenApi)($.z);const Y=$.z.object({accessToken:$.z.string(),refreshToken:$.z.string(),type:$.z.string().optional(),user:J});class AuthOutput extends((0,a.createZodDto)(Y)){}const ee=require("argon2"),te=require("google-auth-library");var ae,ie,re,oe,se;let ne=class AuthService{constructor(e,t,a,i,r){this.prisma=e,this.jwt=t,this.usersService=a,this.configService=i,this.activityService=r,this.google=new te.OAuth2Client(i.get("GOOGLE_CLIENT_ID"),i.get("GOOGLE_CLIENT_SECRET"))}async login(e){const t=await this.validateUser(e),a=this.issueToken(t.id);return{user:this.userFields(t),...a}}async register(e){await this.checkUserExistBeforeCreate(e.email);const t=await this.getPopular(),a=await this.prisma.user.create({data:{email:e.email,password:await(0,ee.hash)(e.password),selectedGenres:{connect:t.map((e=>({slug:e.slug})))}}});await this.activityService.create({type:y.Activities.registerNewUser,importance:1,userId:a.id});const i=this.issueToken(a.id);return{user:this.userFields(a),...i}}async googleSign(e){const t=(await this.google.verifyIdToken({idToken:e.socialId,audience:[this.configService.getOrThrow("GOOGLE_CLIENT_ID")]}).catch((()=>{throw G(l.HttpStatus.BAD_REQUEST,k)}))).getPayload();if(!t?.sub)throw G(l.HttpStatus.BAD_REQUEST,k);const a=await this.prisma.user.findUnique({where:{socialId:t?.sub}});if(a){console.log("User exist and i just logged in");const e=this.issueToken(a.id);return await this.activityService.create({type:y.Activities.loginUser,importance:1,userId:a.id}),{type:"login",user:this.userFields(a),...e}}if(!t?.email)throw G(l.HttpStatus.BAD_REQUEST,k);await this.checkUserExistBeforeCreate(t.email);const i=await this.getPopular(),r=await this.prisma.user.create({data:{email:t.email,socialId:t.sub,selectedGenres:{connect:i.map((e=>({slug:e.slug})))},role:y.Role.user,fullName:t.given_name&&t.family_name?`${t.given_name} ${t.family_name}`:t?.email?.split("@")[0],picture:t.picture||"fallback.png",location:t.locale||"unknown"}}),o=this.issueToken(r.id);return await this.activityService.create({type:y.Activities.registerNewUser,importance:1,userId:r.id}),{type:"register",user:this.userFields(r),...o}}async refresh(e){const t=await this.jwt.verifyAsync(e).catch((e=>{throw G(l.HttpStatus.BAD_REQUEST,e.message)}));if(!t)throw G(l.HttpStatus.BAD_REQUEST,B);const a=await this.usersService.getUserById(t.id,{email:!0,id:!0});return{user:a,...this.issueToken(a.id)}}async checkUserExistBeforeCreate(e){if(await this.prisma.user.findUnique({where:{email:e}}))throw G(l.HttpStatus.BAD_REQUEST,z)}issueToken(e){const t={id:e};return{accessToken:this.jwt.sign(t,{expiresIn:"development"===this.configService.get("NODE_ENV")?"10s":"15m"}),refreshToken:this.jwt.sign(t,{expiresIn:"10d"})}}async validateUser(e){const t=await this.prisma.user.findUnique({where:{email:e.email}});if(!t?.password)throw G(l.HttpStatus.NOT_FOUND,A);if(!(await(0,ee.verify)(t.password,e.password)))throw G(l.HttpStatus.NOT_FOUND,A);return t}async getPopular(){return this.prisma.genre.findMany({take:3,select:M,orderBy:{activities:{_count:"asc"}}})}userFields(e){return{id:e.id,email:e.email,role:e.role}}};var ce,de,pe,le,ue,me,ge,ye,_e;ne=(0,d.__decorate)([(0,l.Injectable)(),(0,d.__metadata)("design:paramtypes",["function"==typeof(ae=void 0!==f&&f)?ae:Object,"function"==typeof(ie=void 0!==w.JwtService&&w.JwtService)?ie:Object,"function"==typeof(re=void 0!==L&&L)?re:Object,"function"==typeof(oe=void 0!==S.ConfigService&&S.ConfigService)?oe:Object,"function"==typeof(se=void 0!==b&&b)?se:Object])],ne);let he=class AuthController{constructor(e){this.authService=e}async googleSign(e){return this.authService.googleSign(e)}async mailRegister(e){return this.authService.register(e)}async mailLogin(e){return this.authService.login(e)}async refreshToken(e){return this.authService.refresh(e.refreshToken)}};(0,d.__decorate)([(0,l.Post)("/google-sign"),(0,Q.ApiOkResponse)({description:"Return access and refresh token",type:AuthOutput}),(0,Q.ApiBody)({type:GoogleAuthDto,description:"Sign in with google account"}),(0,d.__param)(0,(0,l.Body)()),(0,d.__metadata)("design:type",Function),(0,d.__metadata)("design:paramtypes",["function"==typeof(de=void 0!==GoogleAuthDto&&GoogleAuthDto)?de:Object]),(0,d.__metadata)("design:returntype","function"==typeof(pe="undefined"!=typeof Promise&&Promise)?pe:Object)],he.prototype,"googleSign",null),(0,d.__decorate)([(0,l.Post)("/mail-register"),(0,Q.ApiBody)({type:AuthDto,description:"Register new user"}),(0,Q.ApiOkResponse)({description:"Return access and refresh token",type:AuthOutput}),(0,d.__param)(0,(0,l.Body)()),(0,d.__metadata)("design:type",Function),(0,d.__metadata)("design:paramtypes",["function"==typeof(le=void 0!==AuthDto&&AuthDto)?le:Object]),(0,d.__metadata)("design:returntype","function"==typeof(ue="undefined"!=typeof Promise&&Promise)?ue:Object)],he.prototype,"mailRegister",null),(0,d.__decorate)([(0,l.Post)("/mail-login"),(0,Q.ApiBody)({type:AuthDto,description:"Login user"}),(0,Q.ApiOkResponse)({description:"Return access and refresh token",type:AuthOutput}),(0,d.__param)(0,(0,l.Body)()),(0,d.__metadata)("design:type",Function),(0,d.__metadata)("design:paramtypes",["function"==typeof(me=void 0!==AuthDto&&AuthDto)?me:Object]),(0,d.__metadata)("design:returntype","function"==typeof(ge="undefined"!=typeof Promise&&Promise)?ge:Object)],he.prototype,"mailLogin",null),(0,d.__decorate)([(0,l.Post)("/refresh"),(0,Q.ApiBody)({type:RefreshDto,description:"Refresh access token"}),(0,Q.ApiOkResponse)({description:"Return access token",type:AuthOutput}),(0,d.__param)(0,(0,l.Body)()),(0,d.__metadata)("design:type",Function),(0,d.__metadata)("design:paramtypes",["function"==typeof(ye=void 0!==RefreshDto&&RefreshDto)?ye:Object]),(0,d.__metadata)("design:returntype","function"==typeof(_e="undefined"!=typeof Promise&&Promise)?_e:Object)],he.prototype,"refreshToken",null),he=(0,d.__decorate)([(0,Q.ApiTags)("\ud83d\udd10 auth"),(0,l.Controller)("auth"),(0,d.__metadata)("design:paramtypes",["function"==typeof(ce=void 0!==ne&&ne)?ce:Object])],he);const fe=require("@nestjs/passport"),ve=require("passport-jwt");var be,Se;let we=class JwtStrategy extends((0,fe.PassportStrategy)(ve.Strategy)){constructor(e,t){super({jwtFromRequest:ve.ExtractJwt.fromAuthHeaderAsBearerToken(),ignoreExpiration:!1,secretOrKey:e?.get("JWT_SECRET")}),this.prisma=t}async validate({id:e}){return this.prisma.user.findUnique({where:{id:+e}})}};we=(0,d.__decorate)([(0,l.Injectable)(),(0,d.__metadata)("design:paramtypes",["function"==typeof(be=void 0!==S.ConfigService&&S.ConfigService)?be:Object,"function"==typeof(Se=void 0!==f&&f)?Se:Object])],we);let ke=class AuthModule{};ke=(0,d.__decorate)([(0,l.Module)({controllers:[he],providers:[ne,f,we,L,S.ConfigService,b],imports:[S.ConfigModule,w.JwtModule.registerAsync({imports:[S.ConfigModule],inject:[S.ConfigService],useFactory:async e=>({secret:await e.get("JWT_SECRET")})})]})],ke);const Ae=require("@aws-sdk/client-s3"),ze="ebooks",Be=[ze,"booksCovers"],Oe=require("sharp");var Ee,je,Pe=e.n(Oe);let Te=Ee=class StorageService{constructor(e){this.configService=e,this.s3=new Ae.S3Client({endpoint:this.configService.get("AWS_ENDPOINT"),region:this.configService.get("AWS_REGION"),credentials:{accessKeyId:this.configService.get("AWS_ACCESS_KEY_ID"),secretAccessKey:this.configService.get("AWS_SECRET_ACCESS_KEY")}})}async upload({file:e,fileName:t,folder:a}){if(!Be.includes(a))throw G(l.HttpStatus.BAD_REQUEST,x);const i=a===ze?e:await Pe()(e).resize({height:1200,width:800}).toFormat("jpeg",{progressive:!0,quality:50}).toBuffer(),r=`${a}/${Date.now()-Math.floor(1e3*Math.random())}-${function(e){const[t,a]=e.split(/\.(?=[^.]+$)/);return t&&a?`${t.replaceAll(/[^\s\w-]/g,"").trim().replaceAll(/\s+/g,"-").replaceAll(/-+/g,"-")||"file"}.${a}`:e}(t)}`;return await this.s3.send(new Ae.PutObjectCommand({Bucket:this.configService.get("AWS_BUCKET"),Key:r,Body:i,ACL:"public-read",ContentDisposition:"inline"})).catch((()=>G(l.HttpStatus.BAD_REQUEST,B))),l.Logger.log(`File ${r} uploaded to ${a} folder`,Ee.name),{name:r}}};Te=Ee=(0,d.__decorate)([(0,l.Injectable)(),(0,d.__metadata)("design:paramtypes",["function"==typeof(je=void 0!==S.ConfigService&&S.ConfigService)?je:Object])],Te),(0,W.extendZodWithOpenApi)($.z);const xe=$.z.object({canLoadMore:$.z.boolean(),totalPages:$.z.number()});(0,W.extendZodWithOpenApi)($.z);const Re=$.z.object({message:$.z.string(),time:$.z.string(),importance:$.z.number().min(1).max(10)}),De=$.z.object({date:$.z.string(),count:$.z.number().min(1),level:$.z.number().min(1).max(10),activities:$.z.array(Re)});(0,W.extendZodWithOpenApi)($.z);const Ce=$.z.object({slug:$.z.string(),name:$.z.string(),icon:$.z.string()});class ShortGenre extends((0,a.createZodDto)(Ce)){}(0,W.extendZodWithOpenApi)($.z);const Ie=$.z.object({tags:$.z.array($.z.string()),text:$.z.string().optional().nullable(),rating:$.z.number()});(0,W.extendZodWithOpenApi)($.z);const Ue=$.z.object({slug:$.z.string(),title:$.z.string(),picture:$.z.string(),author:$.z.string()}),Ne=$.z.object({description:$.z.string(),readingTime:$.z.number(),chapters:$.z.number(),rating:$.z.number(),isPublic:$.z.boolean(),genres:$.z.array(Ce)}).merge(Ue),Me=Ne.merge($.z.object({createdAt:$.z.date(),updatedAt:$.z.date(),ebook:$.z.string(),_count:$.z.object({finishedBy:$.z.number(),readingBy:$.z.number(),savedBy:$.z.number()}).strict(),activities:$.z.array(De),review:$.z.array(Ie)}).strict());class ShortBook extends((0,a.createZodDto)(Ue)){}class Book extends((0,a.createZodDto)(Ne)){}class FullBook extends((0,a.createZodDto)(Me)){}(0,W.extendZodWithOpenApi)($.z);const Fe=$.z.object({data:$.z.array(Ne)}).merge(xe);class CatalogOutput extends((0,a.createZodDto)(Fe)){}let Ge=class AdminGuard{canActivate(e){if(e.switchToHttp().getRequest().user.role!==y.Role.admin)throw G(l.HttpStatus.FORBIDDEN,j);return!0}};Ge=(0,d.__decorate)([(0,l.Injectable)()],Ge);class JwtGuard extends((0,fe.AuthGuard)("jwt")){}const qe=(e="user")=>(0,l.applyDecorators)("admin"===e?(0,l.UseGuards)(JwtGuard,Ge):(0,l.UseGuards)(JwtGuard)),He=(0,l.createParamDecorator)(((e,t)=>{const a=t.switchToHttp().getRequest().user;return e?a?.[e]:a})),Ze=e=>e.toString().toLowerCase().trim().replaceAll(/\s+/g,"-").replaceAll(/[^\w-]+/g,""),Le=[["","I","II","III","IV","V","VI","VII","VIII","IX"],["","X","XX","XXX","XL","L","LX","LXX","LXXX","XC"],["","C","CC","CCC","CD","D","DC","DCC","DCCC","CM"]];function Qe(e){let t="";const a=[...e.toString()].reverse();for(const[i,r]of a.entries())t=Le[i][Number.parseInt(r)]+t;return t}const We=e=>{const t=e.split(" ").length/200;return Math.ceil(t)},$e=e=>{const t=We(e.map((e=>e.chapters.map((e=>e.text)).join(" "))).join(" "));return{uploadedEbook:e.map(((e,t)=>({id:t+1,title:e.title,chapters:e.chapters.map(((e,t)=>({id:t+1,romanNumber:Qe(t+1),readingTime:We(e.text),name:e.name,text:e.text})))}))),readingTime:t,chaptersCount:e.map((e=>e.chapters.length)).reduce(((e,t)=>e+t),0)}};var Ve,Xe,Je;let Ke=class BookService{constructor(e,t,a){this.prisma=e,this.activityService=t,this.storageService=a}async infoBySlug(e,t){const a=await this.prisma.book.findUnique({where:{slug:e,isPublic:!0},select:{title:!0,slug:!0,chapters:!0,isPublic:!0,picture:!0,author:!0,description:!0,mainGenre:!1,readingTime:!0,rating:!0,genres:{select:M}}});if(!a)throw G(l.HttpStatus.BAD_REQUEST,O);return await this.activityService.create({type:y.Activities.visitBook,importance:1,userId:t,bookSlug:e}),a}async infoBySlugAdmin(e){const t=await this.prisma.book.findUnique({where:{slug:e},select:{id:!0,chapters:!0,title:!0,picture:!0,author:!0,slug:!0,createdAt:!0,updatedAt:!0,rating:!0,readingTime:!0,genres:{select:{name:!0,slug:!0,icon:!0}},ebook:!0,description:!0,isPublic:!0,review:{select:{tags:!0,text:!0,rating:!0,user:{select:{id:!0,email:!0}}}},_count:{select:{finishedBy:!0,readingBy:!0,savedBy:!0}},activities:{select:{type:!0,id:!0,importance:!0,createdAt:!0,genreId:!0,bookId:!0,userId:!0}}}});if(!t)throw G(l.HttpStatus.BAD_REQUEST,O);const{activities:a,...i}=t;return console.log("rest",i),{...i,activities:U(a)}}async catalog(e,t){const a=await this.prisma.book.count();return{data:await this.prisma.book.findMany({take:20,select:{author:!0,chapters:!0,title:!0,picture:!0,slug:!0,genres:{select:M},readingTime:!0,rating:!0,isPublic:!0,description:!0,mainGenre:{select:M}},orderBy:{isPublic:"asc"},...t&&{skip:20*t},...e&&{where:{title:{contains:e}},...!Number.isNaN(+e)&&{where:{id:+e}}}}),canLoadMore:t<Math.floor(a/20),totalPages:Math.floor(a/20)}}async create(e){const{genreIds:t,mainGenreSlug:a}=await this.getGenres(e.genres),{readingTime:i,uploadedEbook:r,chaptersCount:o}=$e(e.ebook),{name:s}=await this.storageService.upload({folder:"ebooks",file:Buffer.from(JSON.stringify(r)),fileName:e.title+".json"});if(await this.prisma.book.findUnique({where:{title:e.title},select:{id:!0}}))throw G(l.HttpStatus.BAD_REQUEST,D);await this.prisma.book.create({data:{slug:Ze(e.title),activities:{create:{type:y.Activities.createBook,importance:9}},chapters:o,title:e.title,picture:e.picture,rating:e.rating,readingTime:i,description:e.description,ebook:s,author:e.author,genres:{connect:t},mainGenre:{connect:{slug:a}}}})}async remove(e){await this.checkExist({adminVisible:!0,where:{slug:e}}),await this.prisma.review.deleteMany({where:{book:{slug:e}}}),await this.prisma.book.delete({where:{slug:e}})}async update(e,t){const a=await this.prisma.book.findUnique({where:{slug:e},select:{id:!0,title:!0,ebook:!0}});if(!a)throw G(l.HttpStatus.BAD_REQUEST,O);const{genres:i,title:r,ebook:o,...s}=t;let n={...s};if(o){const{uploadedEbook:e,readingTime:t,chaptersCount:i}=$e(o),{name:r}=await this.storageService.upload({folder:"ebooks",file:Buffer.from(JSON.stringify(e)),fileName:`${a.title}.json`});n={...n,ebook:r,readingTime:t,chapters:i}}if(i){const{genreIds:e,mainGenreSlug:t}=await this.getGenres(i);n={...n,genres:{set:e},mainGenre:{connect:{slug:t}}}}r&&(n={...n,slug:Ze(r)}),await this.prisma.book.update({where:{id:a.id},data:n}),await this.activityService.create({type:y.Activities.updateBook,importance:7,bookSlug:e})}async getGenres(e){const t=await this.prisma.genre.findFirst({where:{slug:{in:e.map((e=>e.slug))}},select:{slug:!0},orderBy:{mainBooks:{_count:"asc"}}});if(e.length<2||!t)throw G(l.HttpStatus.BAD_REQUEST,O);return{mainGenreSlug:t.slug,genreIds:e.map((({slug:e})=>({slug:e})))}}async checkExist({where:e,adminVisible:t=!1}){const a=await this.prisma.book.findUnique({where:{...e,...t?{}:{isPublic:!0}},select:{id:!0}});if(!a)throw G(l.HttpStatus.BAD_REQUEST,O);return!!a}};Ke=(0,d.__decorate)([(0,l.Injectable)(),(0,d.__metadata)("design:paramtypes",["function"==typeof(Ve=void 0!==f&&f)?Ve:Object,"function"==typeof(Xe=void 0!==b&&b)?Xe:Object,"function"==typeof(Je=void 0!==Te&&Te)?Je:Object])],Ke);const Ye=$.z.object({id:$.z.number().min(1),title:$.z.string().max(100).min(3).refine((e=>"undefined"!==e),{message:"Name cannot be empty"}).refine((e=>!e.includes(".epub")),{message:"Title cannot include .epub"})}),et=$.z.object({id:$.z.number().min(1),name:$.z.string().refine((e=>!e.includes(".epub")),{message:"Name cannot include .epub"}).refine((e=>"undefined"!==e),{message:"Name cannot be empty"}),text:$.z.string().refine((e=>/<([A-Za-z][A-Za-z0-9]*)\b[^>]*>(.*?)<\/\1>/.test(e)),{message:"Text should be in HTML format"})}),tt=$.z.object({chapters:$.z.array(et).min(1)}).merge(Ye),at=$.z.object({slug:$.z.string(),name:$.z.string(),icon:$.z.string()}),it=$.z.object({title:$.z.string(),author:$.z.string(),description:$.z.string().max(1e3).min(10),ebook:$.z.array(tt).min(1),rating:$.z.number().min(1).positive(),picture:$.z.string(),genres:$.z.array(at).min(1)});(0,W.extendZodWithOpenApi)($.z);class CreateBookDto extends((0,a.createZodDto)(it)){}const rt=$.z.object({slug:$.z.string(),name:$.z.string(),icon:$.z.string()}),ot=$.z.object({title:$.z.string().optional(),author:$.z.string().optional(),description:$.z.string().max(1e3).min(10).optional(),ebook:$.z.array(tt).min(1).optional(),isPublic:$.z.boolean().optional(),rating:$.z.number().min(1).positive().optional(),picture:$.z.string().optional(),genres:$.z.array(rt).min(1).optional()});(0,W.extendZodWithOpenApi)($.z);class UpdateBookDto extends((0,a.createZodDto)(ot)){}var st,nt,ct,dt,pt,lt;let ut=class BookController{constructor(e){this.bookService=e}async infoBySlug(e,t){return this.bookService.infoBySlug(e,+t)}async adminInfoBySlug(e){return this.bookService.infoBySlugAdmin(e)}async catalog(e,t){return this.bookService.catalog(e,t||1)}async create(e){return this.bookService.create(e)}async update(e,t){return this.bookService.update(e,t)}async remove(e){return this.bookService.remove(e)}};(0,d.__decorate)([qe(),(0,l.Get)("/info/by-slug/:slug"),(0,Q.ApiOkResponse)({type:Book}),(0,d.__param)(0,(0,l.Param)("slug")),(0,d.__param)(1,He("id")),(0,d.__metadata)("design:type",Function),(0,d.__metadata)("design:paramtypes",[String,String]),(0,d.__metadata)("design:returntype","function"==typeof(nt="undefined"!=typeof Promise&&Promise)?nt:Object)],ut.prototype,"infoBySlug",null),(0,d.__decorate)([qe("admin"),(0,l.Get)("/admin-info/by-slug/:slug"),(0,Q.ApiOkResponse)({type:FullBook}),(0,d.__param)(0,(0,l.Param)("slug")),(0,d.__metadata)("design:type",Function),(0,d.__metadata)("design:paramtypes",[String]),(0,d.__metadata)("design:returntype","function"==typeof(ct="undefined"!=typeof Promise&&Promise)?ct:Object)],ut.prototype,"adminInfoBySlug",null),(0,d.__decorate)([qe("admin"),(0,l.Get)("/admin/catalog"),(0,Q.ApiOkResponse)({type:CatalogOutput}),(0,d.__param)(0,(0,l.Query)("searchTerm")),(0,d.__param)(1,(0,l.Query)("page")),(0,d.__metadata)("design:type",Function),(0,d.__metadata)("design:paramtypes",[String,Number]),(0,d.__metadata)("design:returntype","function"==typeof(dt="undefined"!=typeof Promise&&Promise)?dt:Object)],ut.prototype,"catalog",null),(0,d.__decorate)([qe("admin"),(0,l.Post)("admin/create"),(0,Q.ApiOkResponse)({type:void 0}),(0,Q.ApiBody)({type:CreateBookDto,description:"Create book"}),(0,d.__param)(0,(0,l.Body)()),(0,d.__metadata)("design:type",Function),(0,d.__metadata)("design:paramtypes",["function"==typeof(pt=void 0!==CreateBookDto&&CreateBookDto)?pt:Object]),(0,d.__metadata)("design:returntype",Promise)],ut.prototype,"create",null),(0,d.__decorate)([qe("admin"),(0,Q.ApiOkResponse)({type:void 0}),(0,l.Put)("admin/update/:slug"),(0,d.__param)(0,(0,l.Param)("slug")),(0,d.__param)(1,(0,l.Body)()),(0,d.__metadata)("design:type",Function),(0,d.__metadata)("design:paramtypes",[String,"function"==typeof(lt=void 0!==UpdateBookDto&&UpdateBookDto)?lt:Object]),(0,d.__metadata)("design:returntype",Promise)],ut.prototype,"update",null),(0,d.__decorate)([qe("admin"),(0,Q.ApiOkResponse)({type:void 0}),(0,l.Delete)("admin/remove/:slug"),(0,d.__param)(0,(0,l.Param)("slug")),(0,d.__metadata)("design:type",Function),(0,d.__metadata)("design:paramtypes",[String]),(0,d.__metadata)("design:returntype",Promise)],ut.prototype,"remove",null),ut=(0,d.__decorate)([(0,Q.ApiTags)("\ud83d\udcd9 book"),(0,Q.ApiBearerAuth)(),(0,l.Controller)("book"),(0,d.__metadata)("design:paramtypes",["function"==typeof(st=void 0!==Ke&&Ke)?st:Object])],ut);let mt=class BookModule{};mt=(0,d.__decorate)([(0,l.Module)({controllers:[ut],providers:[Ke,f,Te,b],exports:[Ke]})],mt),(0,W.extendZodWithOpenApi)($.z);const gt=$.z.object({romanNumber:$.z.string(),readingTime:$.z.number()}).merge(et),yt=$.z.object({chapters:$.z.array(gt).min(1)}).merge(Ye),_t=$.z.object({name:$.z.string(),link:$.z.string()}),ht=$.z.object({title:$.z.string(),children:$.z.array(_t)}),ft=$.z.object({file:$.z.array($.z.string()),chapters:$.z.array(ht)}).merge(Ue.pick({title:!0,picture:!0}));class StoredEBook extends((0,a.createZodDto)(yt)){}(0,a.createZodDto)(et);class EbookOutput extends((0,a.createZodDto)(ft)){}const vt=({name:e,title:t,text:a,readingTime:i,romanNumber:r})=>`<section id="${e+" "+t}">\n\t<div style="\n\twidth: 100%;\n\theight: 80px;\n\tdisplay: flex;\n\tjustify-content: space-between;\n\talign-items: center;">\n\t<div>\n\t<a style="margin: 0; padding: 0; font-size: 18px; margin-bottom:4px">${e}</a>\n\t<p style="margin: 0; padding: 0;">${(e=>{const t=Math.floor(e/60),a=e%60;return`${t>0?t+"h":""} ${a>0?a+"m":""}`})(i)}</p>\n  </div>\n\t<h2 style="margin: 0; padding: 0;">${r}</h2>\n\t</div>\n ${a}\n</section>`;var bt,St;let wt=class EbookService{constructor(e,t){this.prisma=e,this.activityService=t}async storedEbook(e){const t=await this.prisma.book.findUnique({where:{slug:e},select:{id:!0,ebook:!0}});if(!t)throw G(l.HttpStatus.BAD_REQUEST,E);const a=await fetch((i=t.ebook,i?.startsWith("http")?i:`https://f005.backblazeb2.com/file/Booknex/${i}`)).then((e=>e.json())).catch((()=>null));var i;if(!a)throw console.log("error","not found ebook"+e),G(l.HttpStatus.BAD_REQUEST,E);console.log("ebook",a);if(!$.z.array(yt).safeParse(a).success)throw G(l.HttpStatus.BAD_REQUEST,O);return a}async ebookBySlug(e,t){const a=await this.prisma.book.findUnique({where:{slug:e,isPublic:!0},select:{id:!0,title:!0,ebook:!0,picture:!0}});if(!a)throw G(l.HttpStatus.BAD_REQUEST,E);const i=await this.storedEbook(e);return await this.activityService.create({type:y.Activities.getEbook,importance:2,userId:t,bookSlug:e}),{...a,file:i.map((({chapters:e,title:t})=>e.map((({text:e,name:a,romanNumber:i,readingTime:r})=>vt({name:a,title:t,text:e,readingTime:r,romanNumber:i}))).join(" "))),chapters:i.map((({title:e,chapters:t})=>({title:e,children:t.map((({name:t})=>({name:t,link:"#"+(t+" "+e)})))})))}}};var kt,At,zt;wt=(0,d.__decorate)([(0,l.Injectable)(),(0,d.__metadata)("design:paramtypes",["function"==typeof(bt=void 0!==f&&f)?bt:Object,"function"==typeof(St=void 0!==b&&b)?St:Object])],wt);let Bt=class EbookController{constructor(e){this.ebookService=e}async ebookBySlug(e,t){return this.ebookService.ebookBySlug(e,+t)}async storedEbookBySlug(e){return this.ebookService.storedEbook(e)}};(0,d.__decorate)([qe(),(0,l.Get)("/ebook/by-slug/:slug"),(0,Q.ApiOkResponse)({type:EbookOutput}),(0,d.__param)(0,(0,l.Param)("slug")),(0,d.__param)(1,He("id")),(0,d.__metadata)("design:type",Function),(0,d.__metadata)("design:paramtypes",[String,String]),(0,d.__metadata)("design:returntype","function"==typeof(At="undefined"!=typeof Promise&&Promise)?At:Object)],Bt.prototype,"ebookBySlug",null),(0,d.__decorate)([qe("admin"),(0,l.Get)("/admin/stored-ebook/:slug"),(0,Q.ApiOkResponse)({type:[StoredEBook]}),(0,d.__param)(0,(0,l.Param)("slug")),(0,d.__metadata)("design:type",Function),(0,d.__metadata)("design:paramtypes",[String]),(0,d.__metadata)("design:returntype","function"==typeof(zt="undefined"!=typeof Promise&&Promise)?zt:Object)],Bt.prototype,"storedEbookBySlug",null),Bt=(0,d.__decorate)([(0,l.Controller)("ebook"),(0,Q.ApiTags)("\ud83d\udcd9 ebook"),(0,d.__metadata)("design:paramtypes",["function"==typeof(kt=void 0!==wt&&wt)?kt:Object])],Bt);let Ot=class EbookModule{};var Et,jt;Ot=(0,d.__decorate)([(0,l.Module)({controllers:[Bt],providers:[wt,f,b]})],Ot);let Pt=class GenreService{constructor(e,t){this.prisma=e,this.activityService=t}catalog(){return this.prisma.genre.findMany({select:M})}async bySlug(e,t){await this.activityService.create({type:y.Activities.visitGenre,importance:1,userId:t});const a=await this.prisma.genre.findUnique({where:{slug:e},select:{...M,mainBooks:{select:N}}});if(!a)throw G(l.HttpStatus.BAD_REQUEST,O);return a}};var Tt,xt;Pt=(0,d.__decorate)([(0,l.Injectable)(),(0,d.__metadata)("design:paramtypes",["function"==typeof(Et=void 0!==f&&f)?Et:Object,"function"==typeof(jt=void 0!==b&&b)?jt:Object])],Pt);let Rt=class RecommendationService{constructor(e,t){this.prisma=e,this.activityService=t}async recommendation(e){const t=await this.prisma.genre.findMany({where:{users:{some:{id:e}}},select:{slug:!0}});return this.prisma.book.findMany({take:10,orderBy:{rating:"desc"},where:{isPublic:!0,genres:{some:{slug:{in:t.map((e=>e.slug))}}},AND:{NOT:{readingBy:{some:{id:e}},finishedBy:{some:{id:e}},savedBy:{some:{id:e}}}}}})}currentRecommendation(e){return this.prisma.user.findUnique({where:{id:e},select:{selectedGenres:{select:{id:!0,name:!0}}}}).selectedGenres()}async updateRecommendation(e,t){await this.checkUserExist(e);const a=await this.prisma.genre.findMany({where:{slug:{in:t.genreSlugs}},select:{id:!0}});await this.activityService.create({type:y.Activities.updateRecommendations,importance:5,userId:e}),await this.prisma.user.update({where:{id:e},data:{selectedGenres:{set:a}}})}async checkUserExist(e){const t=await this.prisma.user.findUnique({where:{id:e},select:{id:!0}});if(!t)throw G(l.HttpStatus.BAD_REQUEST,C);return!!t}};Rt=(0,d.__decorate)([(0,l.Injectable)(),(0,d.__metadata)("design:paramtypes",["function"==typeof(Tt=void 0!==f&&f)?Tt:Object,"function"==typeof(xt=void 0!==b&&b)?xt:Object])],Rt),(0,W.extendZodWithOpenApi)($.z);const Dt=$.z.object({interestedGenres:$.z.array(Ce),recommendation:$.z.array(Ue),popularBooks:$.z.array(Ue),bestSellingBooks:$.z.array(Ue),newReleases:$.z.array(Ue)});class FeaturedOutput extends((0,a.createZodDto)(Dt)){}var Ct,It,Ut;let Nt=class CatalogService{constructor(e,t,a){this.activityService=e,this.prisma=t,this.recommendationService=a}async featured(e){return await this.activityService.create({type:y.Activities.checkCatalog,importance:1,userId:e}),{interestedGenres:await this.interestedGenres(e),recommendation:await this.recommendationService.recommendation(e),popularBooks:await this.popularBooks(),bestSellingBooks:await this.bestSellingBooks(),newReleases:await this.newReleases()}}search(e){return this.prisma.book.findMany({where:{isPublic:!0,OR:[{title:{mode:"insensitive",contains:e}},{author:{contains:e,mode:"insensitive"}}]}})}async interestedGenres(e){return this.prisma.genre.findMany({where:{users:{every:{id:e}}}})}popularBooks(){return this.prisma.book.findMany({take:10,where:{isPublic:!0},orderBy:{rating:"desc"}})}bestSellingBooks(){return this.prisma.book.findMany({take:10,where:{isPublic:!0},orderBy:{rating:"desc"}})}newReleases(){return this.prisma.book.findMany({take:10,where:{isPublic:!0},orderBy:{updatedAt:"desc"}})}};var Mt,Ft,Gt;Nt=(0,d.__decorate)([(0,l.Injectable)(),(0,d.__metadata)("design:paramtypes",["function"==typeof(Ct=void 0!==b&&b)?Ct:Object,"function"==typeof(It=void 0!==f&&f)?It:Object,"function"==typeof(Ut=void 0!==Rt&&Rt)?Ut:Object])],Nt);let qt=class CatalogController{constructor(e){this.catalogService=e}async search(e){return this.catalogService.search(e)}async featured(e){return this.catalogService.featured(+e)}};(0,d.__decorate)([(0,l.Get)("/search/:query"),(0,Q.ApiOkResponse)({type:[ShortBook]}),(0,d.__param)(0,(0,l.Param)("query")),(0,d.__metadata)("design:type",Function),(0,d.__metadata)("design:paramtypes",[String]),(0,d.__metadata)("design:returntype","function"==typeof(Ft="undefined"!=typeof Promise&&Promise)?Ft:Object)],qt.prototype,"search",null),(0,d.__decorate)([(0,l.Get)("/featured"),(0,Q.ApiOkResponse)({type:FeaturedOutput}),(0,d.__param)(0,He("id")),(0,d.__metadata)("design:type",Function),(0,d.__metadata)("design:paramtypes",[Number]),(0,d.__metadata)("design:returntype","function"==typeof(Gt="undefined"!=typeof Promise&&Promise)?Gt:Object)],qt.prototype,"featured",null),qt=(0,d.__decorate)([qe(),(0,Q.ApiTags)("\ud83d\udcda catalog"),(0,Q.ApiBearerAuth)(),(0,l.Controller)("catalog"),(0,d.__metadata)("design:paramtypes",["function"==typeof(Mt=void 0!==Nt&&Nt)?Mt:Object])],qt);let Ht=class CatalogModule{};Ht=(0,d.__decorate)([(0,l.Module)({controllers:[qt],providers:[Nt,f,b,Pt,Rt]})],Ht),(0,W.extendZodWithOpenApi)($.z);const Zt=$.z.object({mainBooks:$.z.array(Ue)}).merge(Ce);class FindOneGenreOutput extends((0,a.createZodDto)(Zt)){}var Lt,Qt,Wt;let $t=class GenreController{constructor(e){this.genreService=e}async catalog(){return this.genreService.catalog()}async bySlug(e,t){return this.genreService.bySlug(e,+t)}};(0,d.__decorate)([(0,l.Get)(),(0,Q.ApiOkResponse)({type:[ShortGenre]}),(0,d.__metadata)("design:type",Function),(0,d.__metadata)("design:paramtypes",[]),(0,d.__metadata)("design:returntype","function"==typeof(Qt="undefined"!=typeof Promise&&Promise)?Qt:Object)],$t.prototype,"catalog",null),(0,d.__decorate)([qe(),(0,l.Get)("/by-slug/:slug"),(0,Q.ApiOkResponse)({type:FindOneGenreOutput}),(0,d.__param)(0,(0,l.Param)("slug")),(0,d.__param)(1,He("id")),(0,d.__metadata)("design:type",Function),(0,d.__metadata)("design:paramtypes",[String,Number]),(0,d.__metadata)("design:returntype","function"==typeof(Wt="undefined"!=typeof Promise&&Promise)?Wt:Object)],$t.prototype,"bySlug",null),$t=(0,d.__decorate)([(0,Q.ApiTags)("\ud83d\udd16 genre"),(0,Q.ApiBearerAuth)(),(0,l.Controller)("genre"),(0,d.__metadata)("design:paramtypes",["function"==typeof(Lt=void 0!==Pt&&Pt)?Lt:Object])],$t);let Vt=class GenreModule{};Vt=(0,d.__decorate)([(0,l.Module)({controllers:[$t],providers:[Pt,f,b],exports:[Pt]})],Vt);const Xt=require("@nestjs/axios"),Jt=require("@nestjs/terminus");var Kt,Yt;let ea=class HealthController{constructor(e,t){this.health=e,this.http=t}check(){return this.health.check([()=>this.http.pingCheck("nestjs-docs","https://docs.nestjs.com")])}};(0,d.__decorate)([(0,l.Get)(),(0,Q.ApiOkResponse)({description:"Health check",type:Object}),(0,Jt.HealthCheck)(),(0,d.__metadata)("design:type",Function),(0,d.__metadata)("design:paramtypes",[]),(0,d.__metadata)("design:returntype",void 0)],ea.prototype,"check",null),ea=(0,d.__decorate)([(0,l.Controller)("health"),(0,Q.ApiTags)("\u2764\ufe0f health"),(0,d.__metadata)("design:paramtypes",["function"==typeof(Kt=void 0!==Jt.HealthCheckService&&Jt.HealthCheckService)?Kt:Object,"function"==typeof(Yt=void 0!==Jt.HttpHealthIndicator&&Jt.HttpHealthIndicator)?Yt:Object])],ea);let ta=class HealthModule{};ta=(0,d.__decorate)([(0,l.Module)({imports:[Jt.TerminusModule,Xt.HttpModule],controllers:[ea]})],ta);let aa=class ActivityController{};aa=(0,d.__decorate)([(0,l.Controller)("activity")],aa);let ia=class ActivityModule{};ia=(0,d.__decorate)([(0,l.Module)({controllers:[aa],providers:[b,f],exports:[b]})],ia);const ra=$.z.object({JWT_SECRET:$.z.string(),AWS_REGION:$.z.string(),AWS_BUCKET:$.z.string(),AWS_ENDPOINT:$.z.string(),AWS_ACCESS_KEY_ID:$.z.string(),AWS_SECRET_ACCESS_KEY:$.z.string(),DATABASE_URL:$.z.string(),GOOGLE_CLIENT_ID:$.z.string(),GOOGLE_CLIENT_SECRET:$.z.string(),NODE_ENV:$.z.string(),SENTRY_DSN:$.z.string(),MAX_UPLOAD_SIZE:$.z.string().transform((e=>parseInt(e))),PORT:$.z.string().transform((e=>parseInt(e))),SERVER_URL:$.z.string(),STORAGE_URL:$.z.string()});(0,W.extendZodWithOpenApi)($.z);const oa=$.z.object({slug:$.z.string(),title:$.z.string(),author:$.z.string(),description:$.z.string(),picture:$.z.string(),rating:$.z.number().max(5).min(1),genres:$.z.array(Ce)});class BookTemplate extends((0,a.createZodDto)(oa)){}(0,W.extendZodWithOpenApi)($.z);const sa=$.z.object({id:$.z.number(),name:$.z.string(),text:$.z.string()}),na=$.z.object({data:$.z.array(oa)}).merge(xe);class UnfoldOutput extends((0,a.createZodDto)(sa)){}class BookTemplateCatalogOutput extends((0,a.createZodDto)(na)){}const ca=require("@nestjs/platform-express");(0,W.extendZodWithOpenApi)($.z);const da=$.z.object({url:$.z.string().min(1).max(255),page:$.z.number().int().min(0)});class ParserDto extends((0,a.createZodDto)(da)){}const pa=require("puppeteer");var la=e.n(pa);const ua=["https://pagead2.googlesyndication.com","https://creativecdn.com","https://www.googletagmanager.com","https://cdn.krxd.net","https://adservice.google.com","https://cdn.concert.io","https://z.moatads.com","https://cdn.permutive.com"],ma="div.BookPageTitleSection > div > h1",ga="div.BookPageMetadataSection > div.BookPageMetadataSection__contributor > h3 > div > span:nth-child(1) > a > span",ya="div.BookPageMetadataSection > div.BookPageMetadataSection__description > div > div.TruncatedContent__text.TruncatedContent__text--large > div > div > span",_a=".RatingStatistics__rating",ha='[data-testid="pagesFormat"]',fa="div.BookPage__bookCover > div > div > div > div > div > div > img",va="div.BookPageMetadataSection > div.BookPageMetadataSection__genres > ul",ba=async(e,t)=>{await e.goto(t,{waitUntil:"domcontentloaded"}).catch((()=>null)),console.log("go to",t),await e.waitForSelector(ma),await e.waitForSelector(ga),await e.waitForSelector(ya),await e.waitForSelector(_a),await e.waitForSelector(ha),await e.waitForSelector(fa),await e.waitForSelector(va+" > span:nth-child(1) > span > a > .Button__labelItem");return{title:await e.evaluate((()=>{const e=document.querySelector("div.BookPageTitleSection > div > h1");return e?.textContent??"No title"})),author:await e.evaluate((()=>{const e=document.querySelector("div.FeaturedPerson__infoPrimary > h4 > a > span");return{name:e?.textContent??"No author name"}})),description:await e.evaluate((e=>{const t=document.querySelector(e);return t?.textContent?t.textContent.replaceAll(/(Librarian's note|Contributor note|See also).*?\./g,""):"No description"}),ya),rating:await e.evaluate((e=>{const t=document.querySelector(e);return t?.textContent?Number.parseFloat(t.textContent.replaceAll("ratings","").replaceAll(",","").trim()):0}),_a),picture:await e.evaluate((e=>{const t=document.querySelector(e);return t?.getAttribute("src")??"No picture"}),fa),genres:await e.evaluate((e=>[...document.querySelectorAll(e+" > span:nth-child(1) > span > a > .Button__labelItem")].slice(0,3).map((e=>e.textContent))??["No genres"]),va)}},Sa=require("@liquify/prettify");var wa=e.n(Sa);const ka=require("epub2");var Aa=e.n(ka);const za=require("jsdom"),Ba=async e=>new Promise((t=>{const a=new(Aa())(e);a.on("end",(function(){const e=a.flow.map(((e,t)=>new Promise((i=>{try{if(!e.id)return;a.getChapter(e.id,(async(a,r)=>{if(a)return null;if(!r)return null;const o=await(async e=>{const t=new za.JSDOM(String(e)),a=t.window.document.querySelectorAll("*");for(const i of a){""!==i.textContent&&" "!==i.textContent&&"\n"!==i.textContent&&i.textContent&&"\n\n"!==i.textContent||i.remove();const e=i.getAttributeNames();for(const t of e)i.removeAttribute(t);"image"===i.tagName&&i.remove(),"img"===i.tagName&&i.remove(),"svg"===i.tagName&&i.remove(),"iframe"===i.tagName&&i.remove(),"script"===i.tagName&&i.remove(),"style"===i.tagName&&i.remove(),"table"===i.tagName&&i.remove(),"TABLE"===i.tagName&&i.remove(),"SUP"===i.tagName&&i.remove(),"SUB"===i.tagName&&i.remove()}if(!wa().format)throw G(l.HttpStatus.BAD_REQUEST,O);return wa().format(t.window.document.body?.innerHTML||"",{language:"html",indentSize:2,endNewline:!0}).then((e=>e))})(r);return i({id:t+1,name:String(e.title),text:o}),null}))}catch{throw G(l.HttpStatus.BAD_REQUEST,P)}}))));Promise.all(e).then((e=>{const a=e.filter((e=>null!==e?.text));t(a.map(((e,t)=>({id:t+1,name:e?.name||"",text:e?.text||""}))))})).catch((()=>G(l.HttpStatus.BAD_REQUEST,O)))})),a.parse()}));var Oa;let Ea=class ParserService{constructor(e){this.prisma=e}async catalog(e,t){return{data:await this.prisma.bookTemplate.findMany({take:20,select:{title:!0,slug:!0,rating:!0,description:!0,author:!0,genres:!0,picture:!0},...t&&{skip:20*t},...e&&{where:{OR:[{author:{contains:e,mode:"insensitive"}},{title:{contains:e,mode:"insensitive"}}]},...!Number.isNaN(+e)&&{where:{id:+e}}}}),canLoadMore:t<Math.floor(await this.prisma.bookTemplate.count()/20),totalPages:Math.floor(await this.prisma.bookTemplate.count()/20)}}async remove(e){return this.prisma.bookTemplate.delete({where:{slug:e}})}async unfold(e){if(!e.buffer&&"application/epub+zip"!==e.mimetype)throw G(l.HttpStatus.BAD_REQUEST,T);return Ba(e.buffer)}async bySlug(e){const t=await this.prisma.bookTemplate.findUnique({where:{slug:e},select:{title:!0,slug:!0,rating:!0,description:!0,author:!0,picture:!0,genres:!0}});if(!t)throw G(l.HttpStatus.BAD_REQUEST,R);return t}async parse(e){try{const a=await this.prisma.bookTemplate.findMany({select:{title:!0}}),{browser:i,page:r}=await(async()=>{const e=await la().launch({headless:!1,args:["--no-sandbox","--disable-setuid-sandbox"],ignoreHTTPSErrors:!0,ignoreDefaultArgs:["--disable-extensions"]}),t=await e.newPage();return t.setDefaultNavigationTimeout(0),t.setDefaultTimeout(0),await t.setRequestInterception(!0),t.on("request",(e=>{"media"===e.resourceType()||"font"===e.resourceType()||"stylesheet"===e.resourceType()||"manifest"===e.resourceType()||ua.some((t=>e.url().startsWith(t)))?e.abort():e.continue()})),{page:t,browser:e}})(),o=await(async(e,t,a)=>(await e.goto(t+"?page="+a,{waitUntil:"domcontentloaded"}).catch((()=>null)),await e.waitForSelector(".tableList"),e.evaluate((()=>[...document.querySelectorAll(".tableList tr")].map(((e,t)=>{const a=e?.querySelector(".bookTitle")?.getAttribute("href"),i=e.querySelector(".minirating");return{id:t++,link:`https://www.goodreads.com${a}`,ratingAvg:i?.textContent?Number.parseFloat(String(i.textContent.split("\u2014")[0]).replaceAll("avg rating","")):2.5}}))))))(r,e.url,e.page);for(const e of o)try{const{title:t,author:i,description:o,picture:s,genres:n,rating:c}=await ba(r,e.link);if(a.some((e=>e.title===t.trim())))continue;if(c<2)continue;const d=await this.prisma.genre.findMany({where:{OR:n.map((e=>({name:{contains:String(e),mode:"insensitive"}})))}});await this.prisma.bookTemplate.create({data:{title:t.trim(),author:i.name,description:o,slug:Ze(t),picture:s,rating:c,genres:{connect:d.map((e=>({name:e.name})))}}})}catch(t){console.error(t)}await r.close(),await i.close()}catch(t){console.error(t)}}};var ja,Pa,Ta,xa,Ra,Da,Ca;Ea=(0,d.__decorate)([(0,l.Injectable)(),(0,d.__metadata)("design:paramtypes",["function"==typeof(Oa=void 0!==f&&f)?Oa:Object])],Ea);let Ia=class ParserController{constructor(e){this.parserService=e}async catalog(e,t){return this.parserService.catalog(e,t||1)}bySlug(e){return this.parserService.bySlug(e)}async parse(e){return this.parserService.parse(e)}async unfold(e){return this.parserService.unfold(e)}async remove(e){return this.parserService.remove(e)}};(0,d.__decorate)([(0,l.Get)("admin/catalog"),(0,Q.ApiOkResponse)({type:BookTemplateCatalogOutput}),(0,Q.ApiQuery)({name:"searchTerm",required:!1,example:"The Hobbit"}),(0,Q.ApiQuery)({name:"page",required:!1,example:1}),(0,d.__param)(0,(0,l.Query)("searchTerm")),(0,d.__param)(1,(0,l.Query)("page")),(0,d.__metadata)("design:type",Function),(0,d.__metadata)("design:paramtypes",[String,Number]),(0,d.__metadata)("design:returntype","function"==typeof(Pa="undefined"!=typeof Promise&&Promise)?Pa:Object)],Ia.prototype,"catalog",null),(0,d.__decorate)([(0,l.Get)("admin/by-slug/:slug"),(0,Q.ApiOkResponse)({type:BookTemplate}),(0,d.__param)(0,(0,l.Param)("slug")),(0,d.__metadata)("design:type",Function),(0,d.__metadata)("design:paramtypes",[String]),(0,d.__metadata)("design:returntype","function"==typeof(Ta="undefined"!=typeof Promise&&Promise)?Ta:Object)],Ia.prototype,"bySlug",null),(0,d.__decorate)([(0,l.Post)("admin/parse"),(0,Q.ApiBody)({type:ParserDto}),(0,d.__param)(0,(0,l.Body)()),(0,d.__metadata)("design:type",Function),(0,d.__metadata)("design:paramtypes",["function"==typeof(xa=void 0!==ParserDto&&ParserDto)?xa:Object]),(0,d.__metadata)("design:returntype",Promise)],Ia.prototype,"parse",null),(0,d.__decorate)([(0,l.Post)("admin/unfold"),(0,Q.ApiOkResponse)({type:UnfoldOutput,description:"Unfolded book content",isArray:!0}),(0,Q.ApiConsumes)("multipart/form-data"),(0,Q.ApiBody)({schema:{type:"object",properties:{file:{type:"string",format:"binary"}}}}),(0,l.UseInterceptors)((0,ca.FileInterceptor)("file")),(0,d.__param)(0,(0,l.UploadedFile)(new l.ParseFilePipe({validators:[new l.MaxFileSizeValidator({maxSize:1e10})]}))),(0,d.__metadata)("design:type",Function),(0,d.__metadata)("design:paramtypes",["function"==typeof(Da="undefined"!=typeof Express&&void 0!==(Ra=Express.Multer)&&Ra.File)?Da:Object]),(0,d.__metadata)("design:returntype","function"==typeof(Ca="undefined"!=typeof Promise&&Promise)?Ca:Object)],Ia.prototype,"unfold",null),(0,d.__decorate)([(0,l.Delete)("admin/remove/:slug"),(0,d.__param)(0,(0,l.Param)("slug")),(0,d.__metadata)("design:type",Function),(0,d.__metadata)("design:paramtypes",[String]),(0,d.__metadata)("design:returntype",Promise)],Ia.prototype,"remove",null),Ia=(0,d.__decorate)([qe("admin"),(0,Q.ApiTags)("\ud83d\udce6 parser"),(0,Q.ApiBearerAuth)(),(0,l.Controller)("parser"),(0,d.__metadata)("design:paramtypes",["function"==typeof(ja=void 0!==Ea&&Ea)?ja:Object])],Ia);let Ua=class ParserModule{};Ua=(0,d.__decorate)([(0,l.Module)({controllers:[Ia],providers:[Ea,f]})],Ua),(0,W.extendZodWithOpenApi)($.z);const Na=$.z.object({genreSlugs:$.z.array($.z.string()).min(1)});class UpdateRecommendationDto extends((0,a.createZodDto)(Na)){}var Ma,Fa,Ga;let qa=class RecommendationController{constructor(e){this.recommendationService=e}async updateRecommendation(e,t){return this.recommendationService.updateRecommendation(+e,t)}async currentRecommendation(e){return this.recommendationService.currentRecommendation(+e)}};(0,d.__decorate)([qe(),(0,l.Post)("/update-recommendation"),(0,Q.ApiOkResponse)({description:"Recommendation updated"}),(0,Q.ApiBody)({type:UpdateRecommendationDto}),(0,d.__param)(0,He("id")),(0,d.__param)(1,(0,l.Body)()),(0,d.__metadata)("design:type",Function),(0,d.__metadata)("design:paramtypes",[Number,"function"==typeof(Fa=void 0!==UpdateRecommendationDto&&UpdateRecommendationDto)?Fa:Object]),(0,d.__metadata)("design:returntype",Promise)],qa.prototype,"updateRecommendation",null),(0,d.__decorate)([qe(),(0,l.Get)("/recommendation-genre"),(0,Q.ApiOkResponse)({type:[ShortGenre],description:"Recommendation genres"}),(0,d.__param)(0,He("id")),(0,d.__metadata)("design:type",Function),(0,d.__metadata)("design:paramtypes",[Number]),(0,d.__metadata)("design:returntype","function"==typeof(Ga="undefined"!=typeof Promise&&Promise)?Ga:Object)],qa.prototype,"currentRecommendation",null),qa=(0,d.__decorate)([(0,l.Controller)("recommendation"),(0,Q.ApiTags)("\ud83d\udce8 recommendation"),(0,Q.ApiBearerAuth)(),(0,d.__metadata)("design:paramtypes",["function"==typeof(Ma=void 0!==Rt&&Rt)?Ma:Object])],qa);let Ha=class RecommendationModule{};Ha=(0,d.__decorate)([(0,l.Module)({controllers:[qa],providers:[Rt,f,b]})],Ha);const Za=$.z.object({rating:$.z.number().int().min(1).max(5),tags:$.z.array($.z.string()).optional(),comment:$.z.string().optional()});(0,W.extendZodWithOpenApi)($.z);class ReviewBookDto extends((0,a.createZodDto)(Za)){}var La,Qa;let Wa=class ReviewService{constructor(e,t){this.prisma=e,this.activityService=t}async review(e,t,a){await this.checkBookExist(t),await this.checkUserExist(e),await this.activityService.create({type:y.Activities.reviewBook,importance:4,userId:e,bookSlug:t}),await this.prisma.review.create({data:{rating:a.rating,tags:a.tags,text:a.comment,user:{connect:{id:e}},book:{connect:{slug:t}}}})}async checkBookExist(e){const t=await this.prisma.book.findUnique({where:{slug:e,isPublic:!0},select:{id:!0}});if(!t)throw G(l.HttpStatus.BAD_REQUEST,E);return!!t}async checkUserExist(e){const t=await this.prisma.user.findUnique({where:{id:e},select:{id:!0}});if(!t)throw G(l.HttpStatus.BAD_REQUEST,C);return!!t}};var $a,Va;Wa=(0,d.__decorate)([(0,l.Injectable)(),(0,d.__metadata)("design:paramtypes",["function"==typeof(La=void 0!==f&&f)?La:Object,"function"==typeof(Qa=void 0!==b&&b)?Qa:Object])],Wa);let Xa=class ReviewController{constructor(e){this.reviewService=e}async review(e,t,a){return this.reviewService.review(+e,t,a)}};(0,d.__decorate)([(0,l.Post)("/review/:slug"),qe(),(0,Q.ApiOkResponse)({description:"Review book"}),(0,Q.ApiBody)({type:ReviewBookDto,required:!0,description:"Review book"}),(0,d.__param)(0,He("id")),(0,d.__param)(1,(0,l.Param)("slug")),(0,d.__param)(2,(0,l.Body)()),(0,d.__metadata)("design:type",Function),(0,d.__metadata)("design:paramtypes",[Number,String,"function"==typeof(Va=void 0!==ReviewBookDto&&ReviewBookDto)?Va:Object]),(0,d.__metadata)("design:returntype",Promise)],Xa.prototype,"review",null),Xa=(0,d.__decorate)([(0,l.Controller)("review"),(0,Q.ApiTags)("\u2b50 review"),(0,Q.ApiBearerAuth)(),(0,d.__metadata)("design:paramtypes",["function"==typeof($a=void 0!==Wa&&Wa)?$a:Object])],Xa);let Ja=class ReviewModule{};Ja=(0,d.__decorate)([(0,l.Module)({controllers:[Xa],providers:[Wa,f,b]})],Ja),(0,W.extendZodWithOpenApi)($.z);const Ka=$.z.object({name:$.z.string()});class UploadOutputDto extends((0,a.createZodDto)(Ka)){}var Ya,ei,ti,ai;let ii=class StorageController{constructor(e){this.uploadService=e}async upload(e,t){return this.uploadService.upload({file:e.buffer,fileName:e.originalname,folder:t})}};(0,d.__decorate)([(0,l.Post)("/:folder"),(0,Q.ApiParam)({name:"folder",enum:Be}),(0,l.UseInterceptors)((0,ca.FileInterceptor)("file")),(0,Q.ApiConsumes)("multipart/form-data"),(0,Q.ApiBody)({schema:{type:"object",properties:{file:{type:"string",format:"binary"}}}}),(0,Q.ApiOkResponse)({description:"File uploaded",type:UploadOutputDto}),(0,d.__param)(0,(0,l.UploadedFile)(new l.ParseFilePipe({validators:[new l.MaxFileSizeValidator({maxSize:Number(process.env.MAX_FILE_SIZE)})]}))),(0,d.__param)(1,(0,l.Param)("folder")),(0,d.__metadata)("design:type",Function),(0,d.__metadata)("design:paramtypes",["function"==typeof(ti="undefined"!=typeof Express&&void 0!==(ei=Express.Multer)&&ei.File)?ti:Object,Object]),(0,d.__metadata)("design:returntype","function"==typeof(ai="undefined"!=typeof Promise&&Promise)?ai:Object)],ii.prototype,"upload",null),ii=(0,d.__decorate)([(0,Q.ApiTags)("storage"),(0,Q.ApiBearerAuth)(),(0,l.Controller)("storage"),qe("admin"),(0,d.__metadata)("design:paramtypes",["function"==typeof(Ya=void 0!==Te&&Te)?Ya:Object])],ii);let ri=class StorageModule{};ri=(0,d.__decorate)([(0,l.Module)({controllers:[ii],providers:[Te],imports:[S.ConfigModule],exports:[Te]})],ri),(0,W.extendZodWithOpenApi)($.z);const oi=$.z.object({id:$.z.number(),createdAt:$.z.date(),email:$.z.string().email(),socialId:$.z.string().nullable().optional(),picture:$.z.string(),fullName:$.z.string(),location:$.z.string()});(0,a.createZodDto)(oi);(0,W.extendZodWithOpenApi)($.z);const si=$.z.object({id:$.z.number(),email:$.z.string(),selectedGenres:$.z.array(Ce),activities:$.z.array(De),_count:$.z.object({savedBooks:$.z.number(),finishedBooks:$.z.number(),readingBooks:$.z.number()}).strict()}).merge(oi),ni=$.z.object({data:$.z.array(si)}).merge(xe),ci=$.z.object({readingBooks:$.z.array(Ue),finishedBooks:$.z.array(Ue),savedBooks:$.z.array(Ue)});class UserCatalogOutput extends((0,a.createZodDto)(ni)){}class UserLibraryOutput extends((0,a.createZodDto)(ci)){}var di,pi;let li=class UserController{constructor(e){this.usersService=e}async library(e){return this.usersService.library(+e)}async startReading(e,t){return this.usersService.startReading(e,t)}async finishReading(e,t){return this.usersService.finishReading(e,t)}async toggleSave(e,t){return this.usersService.toggleSave(e,t)}async isSaved(e,t){return this.usersService.isSaved(e,t)}async catalog(e,t){return this.usersService.catalog(e||"",t)}async remove(e){return this.usersService.remove(+e)}};(0,d.__decorate)([qe(),(0,l.Get)("/library"),(0,Q.ApiOkResponse)({type:UserLibraryOutput}),(0,d.__param)(0,He("id")),(0,d.__metadata)("design:type",Function),(0,d.__metadata)("design:paramtypes",[Number]),(0,d.__metadata)("design:returntype",Promise)],li.prototype,"library",null),(0,d.__decorate)([qe(),(0,l.Patch)("/start-reading/:slug"),(0,d.__param)(0,He("id")),(0,d.__param)(1,(0,l.Param)("slug")),(0,d.__metadata)("design:type",Function),(0,d.__metadata)("design:paramtypes",[Number,String]),(0,d.__metadata)("design:returntype",Promise)],li.prototype,"startReading",null),(0,d.__decorate)([qe(),(0,l.Patch)("/finish-reading/:slug"),(0,d.__param)(0,He("id")),(0,d.__param)(1,(0,l.Param)("slug")),(0,d.__metadata)("design:type",Function),(0,d.__metadata)("design:paramtypes",[Number,String]),(0,d.__metadata)("design:returntype",Promise)],li.prototype,"finishReading",null),(0,d.__decorate)([qe(),(0,l.Patch)("/toggle-save/:slug"),(0,Q.ApiOkResponse)({type:Boolean}),(0,d.__param)(0,He("id")),(0,d.__param)(1,(0,l.Param)("slug")),(0,d.__metadata)("design:type",Function),(0,d.__metadata)("design:paramtypes",[Number,String]),(0,d.__metadata)("design:returntype",Promise)],li.prototype,"toggleSave",null),(0,d.__decorate)([qe(),(0,l.Get)("/is-saved/:slug"),(0,Q.ApiOkResponse)({type:Boolean}),(0,d.__param)(0,He("id")),(0,d.__param)(1,(0,l.Param)("slug")),(0,d.__metadata)("design:type",Function),(0,d.__metadata)("design:paramtypes",[Number,String]),(0,d.__metadata)("design:returntype",Promise)],li.prototype,"isSaved",null),(0,d.__decorate)([qe("admin"),(0,l.Get)("admin/catalog"),(0,Q.ApiOkResponse)({type:UserCatalogOutput}),(0,d.__param)(0,(0,l.Query)("searchTerm")),(0,d.__param)(1,(0,l.Query)("cursor")),(0,d.__metadata)("design:type",Function),(0,d.__metadata)("design:paramtypes",[String,Number]),(0,d.__metadata)("design:returntype","function"==typeof(pi="undefined"!=typeof Promise&&Promise)?pi:Object)],li.prototype,"catalog",null),(0,d.__decorate)([qe("admin"),(0,l.Delete)("admin/remove/:id"),(0,d.__param)(0,(0,l.Param)("id")),(0,d.__metadata)("design:type",Function),(0,d.__metadata)("design:paramtypes",[Number]),(0,d.__metadata)("design:returntype",Promise)],li.prototype,"remove",null),li=(0,d.__decorate)([(0,Q.ApiBearerAuth)(),(0,l.Controller)("user"),(0,Q.ApiTags)("\ud83d\udc64 user"),(0,d.__metadata)("design:paramtypes",["function"==typeof(di=void 0!==L&&L)?di:Object])],li);let ui=class UserModule{};ui=(0,d.__decorate)([(0,l.Module)({controllers:[li],providers:[L,f,b],exports:[L],imports:[S.ConfigModule]})],ui);let mi=class AppLoggerMiddleware{constructor(){this.logger=new l.Logger("HTTP")}use(e,t,a){const{method:i,originalUrl:r}=e,o=process.hrtime();t.on("finish",(()=>{const{statusCode:e}=t,a=process.hrtime(o),s=1e3*a[0]+1e-6*a[1];var n;this.logger.log(`${i} ${r.replace("/api","")} ${e} ${n=s,(n/1e3).toFixed(2)}s`)})),a()}};mi=(0,d.__decorate)([(0,l.Injectable)()],mi);let gi=class AppModule{configure(e){e.apply(mi).forRoutes("*")}};gi=(0,d.__decorate)([(0,l.Module)({imports:[ui,Ht,S.ConfigModule.forRoot({isGlobal:!0,validate:e=>ra.parse(e)}),Vt,mt,ke,ri,Ua,ia,p.CacheModule.register({isGlobal:!0,max:1e3,ttl:60}),u.ThrottlerModule.forRoot([{ttl:60,limit:10}]),Ja,Ha,ta,Ot],controllers:[m],providers:[g]})],gi);let yi=class HttpExceptionFilter{catch(e,t){const a=t.switchToHttp(),i=a.getResponse(),r=a.getRequest(),o=e.getStatus();i.status(o).json({statusCode:o,timestamp:(new Date).toISOString(),path:r.url,message:e.message})}};yi=(0,d.__decorate)([(0,l.Catch)(l.HttpException)],yi);let _i=class SentryFilter extends i.BaseExceptionFilter{catch(e,t){r.captureException(e),super.catch(e,t)}};_i=(0,d.__decorate)([(0,l.Catch)()],_i);const hi="Booknex",fi=(new Q.DocumentBuilder).setTitle(hi).setContact(hi,"https://github.com/kravchenko-anton/booknex-2-monorepo","Github repository").setVersion("1.0").addTag("\ud83d\udc64 user","user service").addTag("\ud83d\udd10 auth","auth service").addTag("\ud83d\udcd9 book","book service").addTag("\ud83d\udcda catalog","catalog service").addTag("\u2764\ufe0f health","health service").addTag("\ud83d\udd16 genre","genre service").addTag("\ud83d\udcc1 storage","storage service").addTag("\u2b50 review","review service").addTag("\ud83d\udce8 recommendation","recommendation service").addTag("\ud83d\udce6 parser","parser service").addBearerAuth(),vi={webServerOptions:{enabled:"development"===process.env.NODE_ENV,path:"api-docs"},fileGeneratorOptions:{enabled:"development"===process.env.NODE_ENV,outputFilePath:"./openapi.yaml"},clientGeneratorOptions:{enabled:"development"===process.env.NODE_ENV,type:"typescript-axios",outputFolderPath:"./libs/global/api-client",additionalProperties:"apiPackage=clients,modelPackage=models,withoutPrefixEnums=true,withSeparateModelsAndApi=true",openApiFilePath:"./openapi.yaml",skipValidation:!0}};!async function(){const e=await i.NestFactory.create(gi),{httpAdapter:t}=e.get(i.HttpAdapterHost);e.useGlobalFilters(new yi),e.enableCors({}),e.use(n()()),e.useGlobalPipes(new a.ZodValidationPipe),e.use((0,o.json)({limit:"10mb"})),await c.OpenApiNestFactory.configure(e,fi,vi),r.init({dsn:process.env.SENTRY_DSN,environment:process.env.NODE_ENV||"development"}),e.useGlobalFilters(new _i(t)),await e.listen(process.env.PORT||3e3)}();var bi=exports;for(var Si in t)bi[Si]=t[Si];t.__esModule&&Object.defineProperty(bi,"__esModule",{value:!0})})();